/*BassoonTracker v0.3.9 by Steffest - build 2021-01-16 - Full source on https://github.com/steffest/BassoonTracker */
var BassoonTracker=function(){function I(e,t){function i(e){(e=0===e?e:e||o.index)<0&&(e=0),o.length<=e&&(e=o.length-1),o.index=e}var o={index:0,litteEndian:!t,goto:function(e){i(e)},jump:function(e){this.goto(this.index+e)},readByte:function(e){i(e);var t=this.dataView.getInt8(this.index);return this.index++,t},writeByte:function(e,t){i(t),this.dataView.setInt8(this.index,e),this.index++},readUbyte:function(e){i(e);var t=this.dataView.getUint8(this.index);return this.index++,t},writeUByte:function(e,t){i(t),this.dataView.setUint8(this.index,e),this.index++},readUint:function(e){i(e);var t=this.dataView.getUint32(this.index,this.litteEndian);return this.index+=4,t},writeUint:function(e,t){i(t),this.dataView.setUint32(this.index,e,this.litteEndian),this.index+=4},readBytes:function(e,t){i(t);var n=new Uint8Array(e),r=this.index;(e+=r)>this.length&&(e=this.length);for(var a=0;r<e;++r)n.setUint8(a++,this.dataView.getUint8(r));return this.index=e,n},readString:function(e,t){i(t);var n=this.index,r=this.dataView,a="";for((e+=n)>this.length&&(e=this.length);n<e;++n){var o=r.getUint8(n);if(0==o)break;a+=String.fromCharCode(o)}return this.index=e,a},writeString:function(e,t){i(t);for(var n=this.dataView,r=e.length,a=0;a<r;a++)n.setUint8(this.index+a,e.charCodeAt(a));this.index+=r},writeStringSection:function(e,t,n,r){i(r),n=n||0;var a=(e=e||"").length;(t=t||1)<a&&(e=e.substr(0,t)),o.writeString(e),o.fill(n,t-a)},readWord:function(e){i(e);var t=this.dataView.getUint16(this.index,this.litteEndian);return this.index+=2,t},writeWord:function(e,t){i(t),this.dataView.setUint16(this.index,e,this.litteEndian),this.index+=2}};return o.readLong=o.readDWord=o.readUint,o.writeLong=o.writeDWord=o.writeUint,o.readShort=function(e,t){i(t);var n=this.dataView.getInt16(this.index,this.litteEndian);return this.index+=2,n},o.clear=function(e){o.fill(0,e)},o.fill=function(e,t){e=e||0,t=t||0;for(var n=0;n<t;n++)o.writeByte(e)},o.isEOF=function(e){return this.length-(e=e||0)<=this.index},e&&(o.buffer=e,o.dataView=new DataView(e),o.length=e.byteLength),o}var e,t,o,V=((t={}).useUrlParams=!0,t.useDropbox=!0,t.showInternalMenu=!0,t.useWebWorkers=!0,t.useInitialLoad=!0,t.init=function(){"object"==typeof HostBridge&&((e=HostBridge).init(),"boolean"==typeof e.useUrlParams&&(t.useUrlParams=e.useUrlParams),"boolean"==typeof e.useDropbox&&(t.useDropbox=e.useDropboxs),"boolean"==typeof e.showInternalMenu&&(t.showInternalMenu=e.showInternalMenu),"boolean"==typeof e.useWebWorkers&&(t.useWebWorkers=e.useWebWorkers))},t.getBaseUrl=function(){return e&&e.getBaseUrl?e.getBaseUrl():"undefined"!=typeof Settings&&Settings.baseUrl||""},t.getRemoteUrl=function(){return e&&e.getRemoteUrl?e.getRemoteUrl():""},t.getVersionNumber=function(){return"undefined"!=typeof versionNumber?versionNumber:e&&e.getVersionNumber?e.getVersionNumber():"dev"},t.getBuildNumber=function(){return"undefined"!=typeof buildNumber?buildNumber:e&&e.getBuildNumber?e.getBuildNumber():(new Date).getTime()},t.signalReady=function(){e&&e.signalReady&&e.signalReady()},t.putFile=function(e,t){},t),C={images:{},audio:{},json:{},arrayBuffer:{}},U=void 0,s=1,A=2,z=1,K=2,X=3,Q=4,Z=5,p=7,J=8,Y=9,$=10,ee=11,te=12,O=13,ne=16,re=17,ae=24,oe=26,ie=28,se=29,m=33,n=36,u=46,ue=53,le=54,de=55,pe=56,me=1,ce=2,c=1,f=2,v=3,x=1,B=2,fe={C1:{period:856,name:"C-1",tune:[907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814]},Cs1:{period:808,name:"C#1",tune:[856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768]},D1:{period:762,name:"D-1",tune:[808,802,796,791,785,779,774,768,762,757,752,746,741,736,730,725]},Ds1:{period:720,name:"D#1",tune:[762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684]},E1:{period:678,name:"E-1",tune:[720,715,709,704,699,694,689,684,678,674,670,665,660,655,651,646]},F1:{period:640,name:"F-1",tune:[678,675,670,665,660,655,651,646,640,637,632,628,623,619,614,610]},Fs1:{period:604,name:"F#1",tune:[640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575]},G1:{period:570,name:"G-1",tune:[604,601,597,592,588,584,580,575,570,567,563,559,555,551,547,543]},Gs1:{period:538,name:"G#1",tune:[570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513]},A1:{period:508,name:"A-1",tune:[538,535,532,528,524,520,516,513,508,505,502,498,495,491,487,484]},As1:{period:480,name:"A#1",tune:[508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457]},B1:{period:453,name:"B-1",tune:[480,477,474,470,467,463,460,457,453,450,447,444,441,437,434,431]},C2:{period:428,name:"C-2",tune:[453,450,447,444,441,437,434,431,428,425,422,419,416,413,410,407]},Cs2:{period:404,name:"C#2",tune:[428,425,422,419,416,413,410,407,404,401,398,395,392,390,387,384]},D2:{period:381,name:"D-2",tune:[404,401,398,395,392,390,387,384,381,379,376,373,370,368,365,363]},Ds2:{period:360,name:"D#2",tune:[381,379,376,373,370,368,365,363,360,357,355,352,350,347,345,342]},E2:{period:339,name:"E-2",tune:[360,357,355,352,350,347,345,342,339,337,335,332,330,328,325,323]},F2:{period:320,name:"F-2",tune:[339,337,335,332,330,328,325,323,320,318,316,314,312,309,307,305]},Fs2:{period:302,name:"F#2",tune:[320,318,316,314,312,309,307,305,302,300,298,296,294,292,290,288]},G2:{period:285,name:"G-2",tune:[302,300,298,296,294,292,290,288,285,284,282,280,278,276,274,272]},Gs2:{period:269,name:"G#2",tune:[285,284,282,280,278,276,274,272,269,268,266,264,262,260,258,256]},A2:{period:254,name:"A-2",tune:[269,268,266,264,262,260,258,256,254,253,251,249,247,245,244,242]},As2:{period:240,name:"A#2",tune:[254,253,251,249,247,245,244,242,240,239,237,235,233,232,230,228]},B2:{period:226,name:"B-2",tune:[240,238,237,235,233,232,230,228,226,225,224,222,220,219,217,216]},C3:{period:214,name:"C-3",tune:[226,225,223,222,220,219,217,216,214,213,211,209,208,206,205,204]},Cs3:{period:202,name:"C#3",tune:[214,212,211,209,208,206,205,203,202,201,199,198,196,195,193,192]},D3:{period:190,name:"D-3",tune:[202,200,199,198,196,195,193,192,190,189,188,187,185,184,183,181]},Ds3:{period:180,name:"D#3",tune:[190,189,188,187,185,184,183,181,180,179,177,176,175,174,172,171]},E3:{period:170,name:"E-3",tune:[180,179,177,176,175,174,172,171,170,169,167,166,165,164,163,161]},F3:{period:160,name:"F-3",tune:[170,169,167,166,165,164,163,161,160,159,158,157,156,155,154,152]},Fs3:{period:151,name:"F#3",tune:[160,159,158,157,156,155,154,152,151,150,149,148,147,146,145,144]},G3:{period:143,name:"G-3",tune:[151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136]},Gs3:{period:135,name:"G#3",tune:[143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128]},A3:{period:127,name:"A-3",tune:[135,134,133,132,131,130,129,128,127,126,125,125,124,123,122,121]},As3:{period:120,name:"A#3",tune:[127,126,125,125,123,123,122,121,120,119,118,118,117,116,115,114]},B3:{period:113,name:"B-3",tune:[120,119,118,118,117,116,115,114,113,113,112,111,110,109,109,108]}},ve={None:{name:"---"},C0:{name:"C-0",period:6848},Cs0:{name:"C#0",period:6464},D0:{name:"D-0",period:6096},Ds0:{name:"D#0",period:5760},E0:{name:"E-0",period:5424},F0:{name:"F-0",period:5120},Fs0:{name:"F#0",period:4832},G0:{name:"G-0",period:4560},Gs0:{name:"G#0",period:4304},A0:{name:"A-0",period:4064},As0:{name:"A#0",period:3840},B0:{name:"B-0",period:3624},C1:{name:"C-1",period:3424},Cs1:{name:"C#1",period:3232},D1:{name:"D-1",period:3048},Ds1:{name:"D#1",period:2880},E1:{name:"E-1",period:2712},F1:{name:"F-1",period:2560},Fs1:{name:"F#1",period:2416},G1:{name:"G-1",period:2280},Gs1:{name:"G#1",period:2152},A1:{name:"A-1",period:2032},As1:{name:"A#1",period:1920},B1:{name:"B-1",period:1812},C2:{name:"C-2",period:1712},Cs2:{name:"C#2",period:1616},D2:{name:"D-2",period:1524},Ds2:{name:"D#2",period:1440},E2:{name:"E-2",period:1356},F2:{name:"F-2",period:1280},Fs2:{name:"F#2",period:1208},G2:{name:"G-2",period:1140},Gs2:{name:"G#2",period:1076},A2:{name:"A-2",period:1016},As2:{name:"A#2",period:960},B2:{name:"B-2",period:906},C3:{name:"C-3",period:856},Cs3:{name:"C#3",period:808},D3:{name:"D-3",period:762},Ds3:{name:"D#3",period:720},E3:{name:"E-3",period:678},F3:{name:"F-3",period:640},Fs3:{name:"F#3",period:604},G3:{name:"G-3",period:570},Gs3:{name:"G#3",period:538},A3:{name:"A-3",period:508},As3:{name:"A#3",period:480},B3:{name:"B-3",period:453},C4:{name:"C-4",period:428},Cs4:{name:"C#4",period:404},D4:{name:"D-4",period:381},Ds4:{name:"D#4",period:360},E4:{name:"E-4",period:339},F4:{name:"F-4",period:320},Fs4:{name:"F#4",period:302},G4:{name:"G-4",period:285},Gs4:{name:"G#4",period:269},A4:{name:"A-4",period:254},As4:{name:"A#4",period:240},B4:{name:"B-4",period:226.5,modPeriod:226},C5:{name:"C-5",period:214},Cs5:{name:"C#5",period:202},D5:{name:"D-5",period:190.5,modPeriod:190},Ds5:{name:"D#5",period:180},E5:{name:"E-5",period:169.5,modPeriod:170},F5:{name:"F-5",period:160},Fs5:{name:"F#5",period:151},G5:{name:"G-5",period:142.5,modPeriod:143},Gs5:{name:"G#5",period:134.5,modPeriod:135},A5:{name:"A-5",period:127},As5:{name:"A#5",period:120},B5:{name:"B-5",period:113.25,modPeriod:113},C6:{name:"C-6",period:107},Cs6:{name:"C#6",period:101},D6:{name:"D-6",period:95.25,modPeriod:95},Ds6:{name:"D#6",period:90},E6:{name:"E-6",period:84.75,modPeriod:85},F6:{name:"F-6",period:80},Fs6:{name:"F#6",period:75.5,modPeriod:75},G6:{name:"G-6",period:71.25,modPeriod:71},Gs6:{name:"G#6",period:67.25,modPeriod:67},A6:{name:"A-6",period:63.5,modPeriod:63},As6:{name:"A#6",period:60},B6:{name:"B-6",period:56.625,modPeriod:56},C7:{name:"C-7",period:53.5,modPeriod:53},Cs7:{name:"C#7",period:50.5,modPeriod:50},D7:{name:"D-7",period:47.625,modPeriod:47},Ds7:{name:"D#7",period:45},E7:{name:"E-7",period:42.375,modPeriod:42},F7:{name:"F-7",period:40},Fs7:{name:"F#7",period:37.75,modPeriod:37},G7:{name:"G-7",period:35.625,modPeriod:35},Gs7:{name:"G#7",period:33.625,modPeriod:33},A7:{name:"A-7",period:31.75,modPeriod:31},As7:{name:"A#7",period:30},B7:{name:"B-7",period:28.3125,modPeriod:28},C8:{name:"C-8",period:26.75},Cs8:{name:"C#8",period:25.25},D8:{name:"D-8",period:23.8125},Ds8:{name:"D#8",period:22.5},E8:{name:"E-8",period:21.1875},F8:{name:"F-8",period:20},Fs8:{name:"F#8",period:18.875},G8:{name:"G-8",period:17.8125},Gs8:{name:"G#8",period:16.8125},A8:{name:"A-8",period:15.875},As8:{name:"A#8",period:15},B8:{name:"B-8",period:14.15625},C9:{name:"C-9",period:13.375},Cs9:{name:"C#9",period:12.625},D9:{name:"D-9",period:11.90625},Ds9:{name:"D#9",period:11.25},E9:{name:"E-9",period:10.59375},F9:{name:"F-9",period:10},Fs9:{name:"F#9",period:9.4375},G9:{name:"G-9",period:8.90625},Gs9:{name:"G#9",period:8.40625},A9:{name:"A-9",period:7.9375},As9:{name:"A#9",period:7.5},B9:{name:"B-9",period:7.078125},C10:{name:"C-10",period:6.6875},Cs10:{name:"C#10",period:6.3125},D10:{name:"D-10",period:5.953125},Ds10:{name:"D#10",period:5.625},E10:{name:"E-10",period:5.296875},F10:{name:"F-10",period:5},Fs10:{name:"F#10",period:4.71875},G10:{name:"G-10",period:4.453125},Gs10:{name:"G#10",period:4.203125},A10:{name:"A-10",period:3.96875},As10:{name:"A#10",period:3.75},B10:{name:"B-10",period:3.5390625},C11:{name:"C-11",period:3.34375},Cs11:{name:"C#11",period:3.15625},D11:{name:"D-11",period:2.9765625},Ds11:{name:"D#11",period:2.8125},E11:{name:"E-11",period:2.6484375},F11:{name:"F-11",period:2.5},Fs11:{name:"F#11",period:2.359375},G11:{name:"G-11",period:2.2265625},Gs11:{name:"G#11",period:2.1015625},A11:{name:"A-11",period:1.984375},As11:{name:"A#11",period:1.875},B11:{name:"B-11",period:1.76953125},OFF:{name:"OFF",period:0}},ge=145,he=1,be=2,ye={unrollLoops:!1,unrollShortLoops:!1,sustainKeyboardNotes:!1,useHover:!0,keyboardTable:"qwerty",vubars:!0,stereoSeparation:f,emulateProtracker1OffsetBug:!0,loadInitialFile:!0},Te=(o={},{on:function(e,t){var n=o[e];n||(o[e]=n=[]),n.push(t)},trigger:function(e,t){var n=o[e];if(n){var r,a=n.length;for(r=0;r<a;r++)n[r](t,e)}}}),we=function(){function a(e,t){(n=e.createGain()).gain.setValueAtTime(1,0);n.connect(t||e.destination),(o=e.createGain()).connect(n),A.setMasterVolume(1),(i=e.createBiquadFilter()).type="lowpass",i.frequency.setValueAtTime(2e4,0),i.connect(o),A.masterVolume=o,A.cutOffVolume=n,A.lowPassfilter=i}var x,o,n,i,C,A={};window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var t,r,B,M,I,V=[],s=[],u=f,l=0,U=[[],[],[]],D=0,_=4143.569,d={volume:!0,panning:!0,high:!0,mid:!0,low:!0,lowPass:!0,reverb:!0,distortion:!1},W=!1;return AudioContext&&(x=new AudioContext),A.init=function(e,t){function n(){var e=FilterChain(d);e.output().connect(i),V.push(e)}if(A.context=x=e=e||x,e){M=!!we.context.createStereoPanner,I="undefined"!=typeof Editor,a(e,t);var r=Ce.getTrackCount();for(V=[],C=0;C<r;C++)n();A.filterChains=V,A.usePanning=M,W||(Te.on(p,function(e){void 0!==e.track&&V[e.track]&&V[e.track].volumeValue(e.mute?0:70)}),Te.on(ae,function(e){for(C=V.length;C<e;C++)n();Te.trigger(m,e),A.setStereoSeparation(u)}),Te.on(ie,function(e){A.setStereoSeparation()}))}},A.enable=function(){n.gain.setValueAtTime(1,0),A.cutOff=!1},A.disable=function(){n.gain.setValueAtTime(0,0),A.cutOff=!0;U.forEach(function(e,t){e.forEach(function(e){e.gain.cancelScheduledValues(0),e.gain.setValueAtTime(0,0)}),U[t]=[]})},A.checkState=function(){x&&"suspended"===x.state&&x.resume&&x.resume()},A.playSample=function(e,t,n,r,a,o,i){var s;W?s=B:(s=x,A.enable()),t=t||428,void 0===r&&(r=I?Editor.getCurrentTrack():0),o=o||x.currentTime,i===ge&&(n=0);var u,l,d,p=Ce.getInstrument(e),m=t,c=0;if(p){var f,v,g=0,h=0;n=void 0===n?100*p.sample.volume/64:n,c=(p.sample.panning||0)/128,Ce.inFTMode()?Ce.useLinearFrequency?t-=p.getFineTune()/2:p.getFineTune()&&(t=A.getFineTuneForNote(i,p.getFineTune())):p.getFineTune()&&(t=A.getFineTuneForPeriod(t,p.getFineTune())),v=A.getSampleRateForPeriod(t);var b=1;p.sample.data.length?(h=p.sample.data.length,a&&a.offset&&(h<=a.offset.value&&(a.offset.value=h-1),g=a.offset.value/s.sampleRate),f=s.createBuffer(1,h,s.sampleRate),b=v/s.sampleRate):(f=s.createBuffer(1,1,s.sampleRate),g=0);var y=f.getChannelData(0);for(C=0;C<h;C++)y[C]=p.sample.data[C];_=v;var T=s.createBufferSource();T.buffer=f;var w=s.createGain();if(w.gain.value=n/100,w.gain.setValueAtTime(n/100,o),p.sample.loop.enabled&&2<p.sample.loop.length&&(ye.unrollLoops||(T.loop=!0,T.loopStart=p.sample.loop.start/s.sampleRate,T.loopEnd=(p.sample.loop.start+p.sample.loop.length)/s.sampleRate)),p.volumeEnvelope.enabled||p.panningEnvelope.enabled||p.hasVibrato()){var P=p.noteOn(o),F=T;P.volume&&(T.connect(u=P.volume),F=u),P.panning&&(F.connect(l=P.panning),F=l),d=P.scheduled,F.connect(w)}else T.connect(w);var S=we.context.createGain();if(S.gain.setValueAtTime(0,o),S.gain.linearRampToValueAtTime(1,o+.01),w.connect(S),M){var E=we.context.createStereoPanner();E.pan.setValueAtTime(c,o),S.connect(E),E.connect(V[r].input())}else S.connect(V[r].input());T.playbackRate.value=b;T.start(o+0,g);var k={source:T,volume:w,panning:E,volumeEnvelope:u,panningEnvelope:l,volumeFadeOut:S,startVolume:n,currentVolume:n,startPeriod:t,basePeriod:m,noteIndex:i,startPlaybackRate:b,sampleRate:v,instrumentIndex:e,effects:a,track:r,time:o,scheduled:d};return U[D].push(w),W||Te.trigger(O,k),k}return{}},A.playSilence=function(){if(x){var e=x.createBufferSource();e.connect(o),e.start()}},A.playRaw=function(e,t){if(x&&e&&e.length){var n;n=x.createBuffer(1,e.length,x.sampleRate);var r=t/audioContext.sampleRate,a=x.createBufferSource();a.buffer=n,a.loop=!0,a.playbackRate.value=r,a.connect(o),a.start()}},A.isRecording=function(){return t},A.startRecording=function(){if(!t&&x&&x.createMediaStreamDestination){var e=x.createMediaStreamDestination();(r=new MediaRecorder(e.stream)).ondataavailable=function(e){s.push(e.data)},r.onstop=function(e){var t=new Blob(s,{type:"audio/ogg; codecs=opus"});saveAs(t,"recording.opus")},o.connect(e),r.start(),t=!0}},A.stopRecording=function(){t&&(t=!1,r.stop())},A.startRendering=function(e){W=!0,B=new OfflineAudioContext(2,44100*e,44100),A.context=B,A.init(B)},A.stopRendering=function(t){W=!1,B.startRendering().then(function(e){t&&t(e)}).catch(function(e){}),a(A.context=x),A.init(x)},A.setStereoSeparation=function(e){var t,n=Ce.getTrackCount();if(Ce.inFTMode())t=0;else switch(u=e=e||u){case v:t=0,ye.stereoSeparation=v;break;case c:t=1,ye.stereoSeparation=c;break;default:t=.5,ye.stereoSeparation=f}for(C=0;C<n;C++){var r=V[C];r&&r.panningValue(C%4==0||C%4==3?-t:t)}},A.getPrevSampleRate=function(){return _},A.context=x,A.getSemiToneFrom=function(e,t,n){var r=e;if(n&&(e=(e=A.getFineTuneBasePeriod(e,n))||r),t){var a=Pe[e];if(a){var o=Ee.indexOf(a.name),i=Ee[o+t];if(i){var s=Se[i];s&&(r=s.period,n&&(r=A.getFineTuneForPeriod(r,n)))}}}return r},A.getNearestSemiTone=function(e,t){var n=8;if(t){var r=Ce.getInstrument(t);r&&r.sample.finetune&&(n+=r.sample.finetune)}var a=1e5,o=e;for(var i in fe)if(fe.hasOwnProperty(i)){var s=fe[i].tune[n],u=Math.abs(s-e);u<a&&(a=u,o=s)}return o},A.getFineTuneForPeriod=function(e,t){var n=e,r=Pe[e];if(r&&r.tune){var a=8+t;0<=a&&a<r.tune.length&&(n=r.tune[a])}return n},A.getFineTuneForNote=function(e,t){if(e===ge)return 1;var n=ke[e],r=0<t?ke[e+1]:ke[e-1];if(n&&r){var a=Math.abs(r.period-n.period)/127;return n.period-a*t}return n?n.period:1e5},A.getFineTuneBasePeriod=function(e,t){var n=e,r=Fe[t];return r&&(n=r[e]),n},A.getSampleRateForPeriod=function(e){return Ce.inFTMode()?Ce.useLinearFrequency?8363*Math.pow(2,(4608-e)/768):3579364/e:3546895/e},A.limitAmigaPeriod=function(e){return e=Math.max(e,113),e=Math.min(e,856)},A.setAmigaLowPassFilter=function(e,t){i.frequency.setValueAtTime(e?2e3:2e4,t)},A.setMasterVolume=function(e,t){e*=.7,o.gain.setValueAtTime(l,t=t||x.currentTime),o.gain.linearRampToValueAtTime(e,t+.02),l=e},A.slideMasterVolume=function(e,t){o.gain.linearRampToValueAtTime(e*=.7,t=t||x.currentTime),l=e},A.getLastMasterVolume=function(){return l/.7},A.clearScheduledNotesCache=function(){2<++D&&(D=0),U[D]=[]},A.waveFormFunction={sine:function(e,t,n,r){return e+Math.sin(t*n*.8)*r*1.7},saw:function(e,t,n,r){var a=1-Math.abs(t*n/7%1);return e+(a=(a=2*a-1)*r*-2)},square:function(e,t,n,r){var a=Math.sin(t*n)<=0?-1:1;return e+(a=a*r*2)},sawInverse:function(e,t,n,r){var a=Math.abs(t*n/7%1);return e+(a=(a=2*a-1)*r*-2)}},A}();!function(a,o,e){function i(n,e){if(!o[n]){if(!a[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var r=o[n]={exports:{}};a[n][0].call(r.exports,function(e){var t=a[n][1][e];return i(t||e)},r,r.exports)}return o[n].exports}for(var s="function"==typeof require&&require,t=0;t<e.length;t++)i(e[t])}({1:[function(e,t,n){var r=e("./lib/WAAClock");t.exports=r,"undefined"!=typeof window&&(window.WAAClock=r)},{"./lib/WAAClock":2}],3:[function(e,t,n){var r=t.exports={};r.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;t!==window&&null!==t||"process-tick"!==e.data||(e.stopPropagation(),0<n.length&&n.shift()())},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")}},{}],2:[function(e,t,n){var r=e("__browserify_process");if("undefined"!=typeof window&&!AudioContext)throw new Error("This browser doesn't seem to support web audio API");function a(e,t,n){this.clock=e,this.func=n,this.repeatTime=null,this.toleranceLate=o,this.toleranceEarly=i,this._armed=!1,this._latestTime=null,this._earliestTime=null,this.schedule(t)}var o=.1,i=.001;a.prototype.clear=function(){return this.clock._removeEvent(this),this},a.prototype.repeat=function(e){if(0===e)throw new Error("delay cannot be 0");return this.repeatTime=e,this},a.prototype.tolerance=function(e){return"number"==typeof e.late&&(this.toleranceLate=e.late),"number"==typeof e.early&&(this.toleranceEarly=e.early),this._update(),this},a.prototype.isRepeated=function(){return null!==this.repeatTime},a.prototype.schedule=function(e){this._armed=!0,this.deadline=e,this._update(),this._earliestTime<=this.clock.context.currentTime&&(this.clock._removeEvent(this),this._execute())},a.prototype._execute=function(){this._armed=!1,this.clock.context.currentTime<this._latestTime?this.func(this):Te&&Te.trigger(u),!1===this._armed&&this.isRepeated()&&this.schedule(this.deadline+this.repeatTime)},a.prototype._update=function(){this._latestTime=this.deadline+this.toleranceLate,this._earliestTime=this.deadline-this.toleranceEarly,this.clock._removeEvent(this),this.clock._insertEvent(this)};var s=t.exports=function(e,t){this.toleranceEarly=(t=t||{}).toleranceEarly||i,this.toleranceLate=t.toleranceLate||o,this.context=e,this._events=[],this._started=!1};s.prototype.setTimeout=function(e,t){return this._createEvent(e,this._absTime(t))},s.prototype.callbackAtTime=function(e,t){return this._createEvent(e,t)},s.prototype.timeStretch=function(n,e,r){var a=this.context.currentTime;return e.forEach(function(e){e.isRepeated()&&e.repeat(e.repeatTime*r);var t=n+r*(e.deadline-n);if(e.isRepeated())for(;t-e.toleranceEarly<=a;)t+=e.repeatTime;e.schedule(t)}),e},s.prototype.start=function(){if(!1===this._started){var e=this;this._started=!0,this._events=[];this._clockNode=this.context.createScriptProcessor(256,1,1),this._clockNode.connect(this.context.destination),this._clockNode.onaudioprocess=function(){r.nextTick(function(){e._tick()})}}},s.prototype.stop=function(){!0===this._started&&(this._started=!1,this._clockNode.disconnect())},s.prototype._tick=function(){for(var e=this._events.shift();e&&e._earliestTime<=this.context.currentTime;)e._execute(),e=this._events.shift();e&&this._events.unshift(e)},s.prototype._createEvent=function(e,t){var n=new a(this,t,e);return n.tolerance({late:this.toleranceLate,early:this.toleranceEarly}),n},s.prototype._insertEvent=function(e){this._events.splice(this._indexByTime(e._earliestTime),0,e)},s.prototype._removeEvent=function(e){var t=this._events.indexOf(e);-1!==t&&this._events.splice(t,1)},s.prototype._indexByTime=function(e){for(var t,n=0,r=this._events.length;n<r;)t=Math.floor((n+r)/2),this._events[t]._earliestTime<e?n=t+1:r=t;return n},s.prototype._absTime=function(e){return e+this.context.currentTime},s.prototype._relTime=function(e){return e-this.context.currentTime}},{__browserify_process:3}]},{},[1]),FilterChain=function(e){function n(){var e,t,n,r;if(i=o,h&&(l=l||((e=x.createBiquadFilter()).type="highshelf",e.frequency.value=3200,e.gain.value=E,e),i.connect(l),i=l),b&&(d=d||((t=x.createBiquadFilter()).type="peaking",t.frequency.value=1e3,t.Q.value=.5,t.gain.value=S,t),i.connect(d),i=d),y&&(p=p||((n=x.createBiquadFilter()).type="lowshelf",n.frequency.value=320,n.gain.value=F,n),i.connect(p),i=p),T&&(m=m||((r=x.createBiquadFilter()).type="lowpass",r.frequency.value=5e3,r),i.connect(m),i=m),w&&(c=c||x.createConvolver(),(f=f||x.createGain()).gain.value=0,i.connect(f),f.connect(c),s=c),P){var a=x.createWaveShaper();a.curve=function(e){for(var t,n="number"==typeof e?e:50,r=new Float32Array(44100),a=Math.PI/180,o=0;o<44100;++o)r[o]=(3+n)*(t=2*o/44100-1)*20*a/(Math.PI+n*Math.abs(t));return r}(400),a.oversample="4x"}g&&(v=v||we.context.createStereoPanner(),i.connect(v),i=v),u=u||x.createGain(),i.connect(u),s&&s.connect(u),i=u}var t={};e=e||{volume:!0,panning:!0};var o,i,s,u,l,d,p,m,c,f,v,r=(e={volume:!0,panning:!0}).volume,g=e.panning&&we.context.createStereoPanner,h=e.high,b=e.mid,y=e.low,T=e.lowPass,w=e.reverb,P=e.distortion,F=0,S=0,E=0,a=70,k=0,x=we.context;return(o=x.createGain()).gain.value=1,i=o,t.lowValue=function(e){if(y){if(void 0!==e){p.gain.value=20*(F=e)}return F}},t.midValue=function(e){if(b){if(void 0!==e){d.gain.value=20*(S=e)}return S}},t.highValue=function(e){if(h){if(void 0!==e){l.gain.value=20*(E=e)}return E}},t.lowPassFrequencyValue=function(e){if(T){var t=we.context.sampleRate/2,n=Math.log(t/40)/Math.LN2,r=Math.pow(2,n*(e-1));m.frequency.value=t*r}},t.lowPassQualityValue=function(e){T&&(m.Q.value=30*e)},t.reverbValue=function(e){if(w){if(!c.buffer){var t=C.audio["data/reverb/sportcentre.m4a"];if(t)c.buffer=t;else M().load(["data/reverb/sportcentre.m4a"],A,function(){c.buffer=C.audio["data/reverb/sportcentre.m4a"]})}var n=parseInt(e)/100;f.gain.value=n*n}},t.volumeValue=function(e){if(r){if(void 0!==e){var t=(a=e)/100;u.gain.value=t*t}return a}},t.panningValue=function(e,t){if(g)return void 0!==e&&v.pan.setValueAtTime(k=e,t||we.context.currentTime),k},t.setState=function(e,t){o.disconnect(),l&&l.disconnect(),d&&d.disconnect(),p&&p.disconnect(),m&&m.disconnect(),f&&f.disconnect(),v&&v.disconnect(),s=void 0,"high"===e&&(h=!!t),"mid"===e&&(b=!!t),"low"===e&&(y=!!t),"lowPass"===e&&(T=!!t),"reverb"===e&&(w=!!t),"panning"===e&&(g=!!t&&we.context.createStereoPanner),n()},t.input=function(){return o},t.output=function(){return i},n(),t.volumeValue(a),t};var i,r,l,Pe={},Fe={},Se={},Ee=[],ke=[],xe=[],Ce=function(){function e(s){s=s||0,(r=r||new WAAClock(we.context)).start(),we.enable(),U&&U.setStatus("Playing"),q=[],H=[];var u=(y=b.patterns[s]).length,l={},d=0,p=we.context.currentTime+.1,m=.2,c=y,f=w;A=[],T=r.setTimeout(function(e){1<d&&T.repeat(m=1);var t=e.deadline+m;for(we.clearScheduledNotesCache();p<t;){if(l.pause&&!Ce.autoPlay){if(!l.pasuseHandled){var n=p-we.context.currentTime;0<n&&setTimeout(function(){O.pause(),O.setAmigaSpeed(6)},Math.round(1e3*n)+100),l.pasuseHandled=!0}return}if(O.setStateAtTime(p,{patternPos:d,songPos:f}),l.patternDelay){for(l.patternDelay--,B=0;B<S;B++)g(B,p);p+=R*N}else if(l=v(d,p,c,f),p+=R*N,u<=++d||l.patternBreak){if(l.positionBreak&&l.targetSongPosition==f||(q=[],H=[]),d=0,Ce.getPlayType()==me){var r=l.positionBreak?l.targetSongPosition:++f;b.length<=r&&(r=b.restartPosition?b.restartPosition-1:0,Te.trigger(ue)),b.length<=r&&(r=0),(c=b.patterns[s=b.patternTable[f=r]])||(c=h(),b.patterns[s]=c),u=c.length,l.patternBreak&&c.length<(d=l.targetPatternPosition||0)&&(d=0)}else l.patternBreak&&E<(d=l.targetPatternPosition||0)&&(d=0);Te.trigger(le,p-R*N)}}for(B=0;B<S;B++){var a=G[B];if(a&&a.time&&a.scheduled){var o=O.getInstrument(a.instrumentIndex);if(a.scheduled.volume&&a.scheduled.volume<=p+m){var i=o.scheduleEnvelopeLoop(a.volumeEnvelope,a.scheduled.volume,2);a.scheduled.volume+=i}a.scheduled.panning&&a.scheduled.panning<=p+m&&(i=o.scheduleEnvelopeLoop(a.panningEnvelope,a.scheduled.panning,2),a.scheduled.panning+=i)}}},.01).repeat(m).tolerance({early:.1})}function v(e,t,n,r){for(var a,o=(n=n||y)[e],i=S,s={},u=0;u<i;u++)(l=o[u])&&l.effect&&15===l.effect&&(l.param<32?(Ce.setAmigaSpeed(l.param),0===l.param&&(s.pause=!0)):Ce.setBPM(l.param));for(u=0;u<i;u++){var l=o[u];if(l){var d={position:r,step:e},p=t;if(C)p+=(Math.random()*C*2-C)/1e3;(a=m(l,u,p,d)).patternBreak&&(s.patternBreak=!0,s.targetPatternPosition=a.targetPatternPosition||0),a.positionBreak&&(s.positionBreak=!0,s.targetPatternPosition=a.targetPatternPosition||0,s.targetSongPosition=a.targetSongPosition||0),a.patternDelay&&(s.patternDelay=a.patternDelay)}}for(u=0;u<i;u++)g(u,t);return s}function m(e,t,n,r){var a=100,o={},i=e.instrument,s=e.period,u=e.index;s&&!i&&(i=G[t].currentInstrument,a="number"==typeof G[t].currentVolume?G[t].currentVolume:a,ye.emulateProtracker1OffsetBug&&i&&L[t].offset&&L[t].offset.instrument===i&&(o.offset=L[t].offset)),"number"==typeof e.instrument&&(M=O.getInstrument(e.instrument))&&(a=M.sample.volume/64*100,ye.emulateProtracker1OffsetBug&&(L[t].offset=L[t].offset||{},L[t].offset.value=0,L[t].offset.instrument=e.instrument));var l=a,d=!0;if("number"==typeof i&&(M=O.getInstrument(i)),u&&O.inFTMode())if(97===u&&(u=ge),u===ge){var p=M||O.getInstrument(G[t].currentInstrument);a=l=p?p.noteOff(n,G[t]):0,d=!1}else if(M&&(M.setSampleForNoteIndex(u),M.sample.relativeNote&&(u+=M.sample.relativeNote)),O.useLinearFrequency)s=7680-64*(u-1);else{var m=ke[u];m&&(s=m.period)}var c,f,v=e.param,g={};if(e.volumeEffect&&O.inFTMode()){var h=e.volumeEffect;if(c=h>>4,f=15&h,15<h&&h<=80)o.volume={value:a=l=(h-16)/64*100};else switch(c){case 6:o.fade={value:-1*f*100/64};break;case 7:o.fade={value:100*f/64};break;case 8:o.fade={value:100*-f/64,fine:!0};break;case 9:o.fade={value:100*f/64,fine:!0};break;case 10:case 11:break;case 12:o.panning={value:17*(h-192),slide:!1};break;case 13:o.panning={value:h,slide:!0}}}switch(e.effect){case 0:if(v){c=v>>4,f=15&v;var b=0;if(M=M||O.getInstrument(G[t].currentInstrument),O.inFTMode()){if(M){var y=u||G[t].noteIndex,T=M.getPeriodForNote(y,!0);u===ge?o.arpeggio=L[t].arpeggio:(o.arpeggio={root:T,interval1:T-M.getPeriodForNote(y+c,!0),interval2:T-M.getPeriodForNote(y+f,!0),step:1},L[t].arpeggio=o.arpeggio)}}else T=s||G[t].startPeriod,M&&(b=M.getFineTune())&&(T=we.getFineTuneForPeriod(T,b)),o.arpeggio={root:T,interval1:T-we.getSemiToneFrom(T,c,b),interval2:T-we.getSemiToneFrom(T,f,b),step:1}}e.instrument&&(o.volume={value:a});break;case 1:v*=-1,O.inFTMode()&&!v&&L[t].slideUp&&(v=L[t].slideUp.value),o.slide={value:v},L[t].slideUp=o.slide;break;case 2:O.inFTMode()&&!v&&L[t].slideDown&&(v=L[t].slideDown.value),o.slide={value:v},L[t].slideDown=o.slide;break;case 3:d=!1;var w=s;if(O.inFTMode()&&u===ge&&(w=0),G[t].currentInstrument&&(i=G[t].currentInstrument),w&&i)(M=O.getInstrument(i))&&M.getFineTune()&&(w=O.inFTMode()?M.getPeriodForNote(u,!0):we.getFineTuneForPeriod(w,M.getFineTune()));(S=L[t].slide)&&(v=v||S.value),o.slide={value:v,target:w=w||L[t].defaultSlideTarget,canUseGlissando:!0,resetVolume:!!e.instrument,volume:a},L[t].slide=o.slide,e.instrument&&(o.volume={value:a});break;case 4:e.instrument&&(G[t].startVolume&&(o.volume={value:l}),G[t].vibratoTimer=0);var P=(c=v>>4)*R/64,F=L[t].vibrato;0==c&&F&&(P=F.freq),0==(f=15&v)&&F&&(f=F.amplitude),o.vibrato={amplitude:f,freq:P},L[t].vibrato=o.vibrato;break;case 5:var S;d=!1,(w=s)&&i&&(M=O.getInstrument(i))&&M.getFineTune()&&(w=O.inFTMode()?we.getFineTuneForNote(u,M.getFineTune()):we.getFineTuneForPeriod(w,M.getFineTune())),v=1,(S=L[t].slide)&&(w=w||(S.target||0),v=S.value),o.slide={value:v,target:w},L[t].slide=o.slide,e.instrument&&(o.volume={value:a}),(v=e.param)&&(e.param<16?v*=-1:v=e.param>>4,o.fade={value:v=100*v/64,resetOnStep:!!e.instrument},L[t].fade=o.fade);break;case 6:e.instrument&&(G[t].startVolume&&(o.volume={value:l}),G[t].vibratoTimer=0),e.param?(e.param<16?v*=-1:v=15&e.param,o.fade={value:v=100*v/64},L[t].fade=o.fade):Ce.inFTMode()&&L[t].fade&&(o.fade=L[t].fade),L[t].vibrato&&(o.vibrato=L[t].vibrato);break;case 7:s&&!e.instrument&&(G[t].startVolume&&(o.volume={value:l}),G[t].tremoloTimer=0);var E=f=15&v,k=(P=(c=v>>4)*R/64,L[t].tremolo);0==c&&k&&(P=k.freq),0==f&&k&&(E=k.amplitude),o.tremolo={amplitude:E,freq:P},L[t].tremolo=o.tremolo;break;case 8:o.panning={value:v,slide:!1};break;case 9:!(v<<=8)&&L[t].offset&&(v=L[t].offset.stepValue||L[t].offset.value||0);var x=v;ye.emulateProtracker1OffsetBug&&!e.instrument&&L[t].offset&&(v+=L[t].offset.value),o.offset={value:v,stepValue:x},L[t].offset=L[t].offset||{},L[t].offset.value=o.offset.value,L[t].offset.stepValue=o.offset.stepValue,ye.emulateProtracker1OffsetBug&&(e.instrument&&(L[t].offset.instrument=e.instrument),s&&(L[t].offset.value+=x)),e.instrument&&(o.volume={value:a});break;case 10:if(e.param<16?v*=-1:v=e.param>>4,v=100*v/64,!e.param){var C=L[t].fade;C&&(v=C.value)}o.fade={value:v,resetOnStep:!!e.instrument},O.inFTMode()&&(L[t].fade=o.fade);break;case 11:Ce.autoPlay||(g.patternBreak=!0,g.positionBreak=!0,g.targetSongPosition=e.param,g.targetPatternPosition=0);break;case 12:o.volume={value:l=e.param/64*100};break;case 13:g.patternBreak=!0,g.targetPatternPosition=10*(c=v>>4)+(f=15&v);break;case 14:var A=v>>4,B=15&v;switch(A){case 0:O.inFTMode()||we.setAmigaLowPassFilter(!B,n);break;case 1:!(B*=-1)&&L[t].fineSlide&&(B=L[t].fineSlide.value),o.slide={value:B,fine:!0},L[t].fineSlide=o.slide;break;case 2:!B&&L[t].fineSlide&&(B=L[t].fineSlide.value),o.slide={value:B,fine:!0},L[t].fineSlide=o.slide;break;case 3:L[t].glissando=!!B;break;case 4:switch(B){case 1:_=we.waveFormFunction.saw;break;case 2:_=we.waveFormFunction.square;break;case 3:case 4:_=we.waveFormFunction.sine;break;case 5:_=we.waveFormFunction.saw;break;case 6:_=we.waveFormFunction.square;break;case 7:default:_=we.waveFormFunction.sine}break;case 5:if(i){var M=O.getInstrument(i);o.fineTune={original:M.getFineTune(),instrument:M},M.setFineTune(B)}break;case 6:B?(H[t]=H[t]||0,H[t]<B?(H[t]++,g.patternBreak=!0,g.positionBreak=!0,g.targetSongPosition=r.position,g.targetPatternPosition=q[t]||0):H[t]=0):q[t]=r.step;break;case 7:switch(B){case 1:W=we.waveFormFunction.saw;break;case 2:W=we.waveFormFunction.square;break;case 3:case 4:W=we.waveFormFunction.sine;break;case 5:W=we.waveFormFunction.saw;break;case 6:W=we.waveFormFunction.square;break;case 7:default:W=we.waveFormFunction.sine}break;case 8:break;case 9:B&&(o.reTrigger={value:B});break;case 10:o.fade={value:B=100*B/64,fine:!0};break;case 11:o.fade={value:-(B=100*B/64),fine:!0};break;case 12:B?B<R&&(o.cutNote={value:B}):d=!1;break;case 13:B&&(B<R?n+=N*B:d=!1);break;case 14:g.patternDelay=B}break;case 15:e.param<32?Ce.setAmigaSpeed(e.param,n):Ce.setBPM(e.param);break;case 16:v=Math.min(v,64),O.isPlugin||we.setMasterVolume(v/64,n);break;case 17:c=v>>4,f=15&v;var I=64*we.getLastMasterVolume(),V=0;if(c){var U=n+c*N;V=c*(R-1)}else f&&(U=n+f*N,V=-f*(R-1));V&&(v=(I+V)/64,v=Math.max(0,v),v=Math.min(1,v),we.slideMasterVolume(v,U));break;case 20:O.inFTMode()&&(a=l=(p=M||O.getInstrument(G[t].currentInstrument))?p.noteOff(n,G[t]):0,d=!1);break;case 21:case 25:break;case 27:o.reTrigger={value:e.param}}return d&&i&&s&&(D(t,n),G[t]={},M&&(G[t]=M.play(u,s,l,t,o,n)),L[t].defaultSlideTarget=G[t].startPeriod),i&&(G[t].currentInstrument=i,o.fineTune&&o.fineTune.instrument&&o.fineTune.instrument.setFineTune(o.fineTune.original||0)),M&&M.hasVibrato()&&(G[t].hasAutoVibrato=!0),G[t].effects=o,G[t].note=e,g}function D(e,t){try{if(G[e].source){var n=G[e].volume.gain;n.setValueAtTime(G[e].currentVolume/100,t-.002),n.linearRampToValueAtTime(0,t),G[e].source.stop(t+.02)}}catch(e){}}function k(e,t){var n=O.getInstrument(e.instrumentIndex);if(n){var r=-n.vibrato.rate/40,a=n.vibrato.depth/8;if(O.useLinearFrequency&&(a*=4),e.vibratoTimer=e.vibratoTimer||0,n.vibrato.sweep&&e.vibratoTimer<n.vibrato.sweep)a*=1-(n.vibrato.sweep-e.vibratoTimer)/n.vibrato.sweep;var o=n.getAutoVibratoFunction()(t,e.vibratoTimer,r,a);return e.vibratoTimer++,o}return t}function g(e,t){var n=G[e],r=n.effects;if(n&&r){var a,o=!1;if(n.startVibratoTimer=n.vibratoTimer||0,n.resetPeriodOnStep&&n.source)O.setPeriodAtTime(n,p=n.currentPeriod||n.startPeriod,t),n.resetPeriodOnStep=!1;if(r.volume){var i=r.volume.value;n.volume&&n.volume.gain.setValueAtTime(i/100,t),n.currentVolume=i}if(r.panning&&(255===(a=r.panning.value)&&(a=254),n.panning&&n.panning.pan.setValueAtTime((a-127)/127,t)),r.fade){var s;a=r.fade.value;var u=1;s=r.fade.resetOnStep?n.startVolume:n.currentVolume;var l=R;r.fade.fine&&(u=0,l=1);for(var d=u;d<l;d++)n.volume&&(n.volume.gain.setValueAtTime(s/100,t+d*N),s+=a,s=Math.max(s,0),s=Math.min(s,100));n.currentVolume=s}if(r.slide&&n.source){var p=v=n.currentPeriod||n.startPeriod;l=R;r.slide.fine&&(l=2);var m=r.slide.value;if(O.inFTMode()&&O.useLinearFrequency&&(m=4*r.slide.value),a=Math.abs(m),O.inFTMode()&&r.slide.resetVolume&&(n.volumeFadeOut||n.volumeEnvelope)){var c=O.getInstrument(n.instrumentIndex);c&&c.resetVolume(t,n)}n.vibratoTimer=n.startVibratoTimer;for(d=1;d<l;d++){r.slide.target?(L[e].defaultSlideTarget=r.slide.target,p<r.slide.target?r.slide.target<(p+=a)&&(p=r.slide.target):(p-=a)<r.slide.target&&(p=r.slide.target)):(p+=m,L[e].defaultSlideTarget&&(L[e].defaultSlideTarget+=m)),O.inFTMode()||(p=we.limitAmigaPeriod(p));var f=p;r.slide.canUseGlissando&&L[e].glissando&&(f=we.getNearestSemiTone(p,n.instrumentIndex)),f!==n.currentPeriod&&(n.currentPeriod=p,n.hasAutoVibrato&&O.inFTMode()&&(p=k(n,p),o=!0),O.setPeriodAtTime(n,f,t+d*N))}}if(r.arpeggio&&n.source){var v=n.currentPeriod||n.startPeriod;n.resetPeriodOnStep=!0,n.vibratoTimer=n.startVibratoTimer;for(d=0;d<R;d++){var g=d%3;0==g&&(p=v),1==g&&r.arpeggio.interval1&&(p=v-r.arpeggio.interval1),2==g&&r.arpeggio.interval2&&(p=v-r.arpeggio.interval2),n.hasAutoVibrato&&O.inFTMode()&&(p=k(n,p),o=!0),O.setPeriodAtTime(n,p,t+d*N)}}if(r.vibrato||n.hasAutoVibrato&&!o){r.vibrato=r.vibrato||{freq:0,amplitude:0};var h=r.vibrato.freq,b=r.vibrato.amplitude;if(O.inFTMode()&&O.useLinearFrequency&&(b*=4),n.vibratoTimer=n.vibratoTimer||0,n.source){n.resetPeriodOnStep=!0,v=n.currentPeriod||n.startPeriod,n.vibratoTimer=n.startVibratoTimer;for(d=0;d<R;d++)p=_(v,n.vibratoTimer,h,b),n.hasAutoVibrato&&O.inFTMode()?(p=k(n,p),o=!0):n.vibratoTimer++,O.setPeriodAtTime(n,p,t+d*N)}}if(r.tremolo){h=r.tremolo.freq,b=r.tremolo.amplitude;if(n.tremoloTimer=n.tremoloTimer||0,n.volume){var y=n.startVolume;for(d=0;d<R;d++)(y=W(y,n.tremoloTimer,h,b))<0&&(y=0),100<y&&(y=100),n.volume.gain.setValueAtTime(y/100,t+d*N),n.currentVolume=y,n.tremoloTimer++}}if(r.cutNote&&(n.volume&&n.volume.gain.setValueAtTime(0,t+r.cutNote.value*N),n.currentVolume=0),r.reTrigger){var T=n.instrumentIndex,w=n.startPeriod;i=n.startVolume;for(var P=n.noteIndex,F=r.reTrigger.value||1,S=F;S<R;){var E=t+S*N;D(e,E),G[e]=we.playSample(T,w,i,e,r,E,P),S+=F}}}}function i(){U&&U.setInfo(b.title),b.channels&&O.setTrackCount(b.channels),P=n=a=t=void 0,O.setCurrentSongPosition(0),O.setCurrentPatternPos(0),O.setCurrentInstrumentIndex(1),O.clearEffectCache(),Te.trigger(oe,b),Te.trigger(ne,b)}function s(){Te.trigger(pe,0),Te.trigger(de,0),O.setAmigaSpeed(6),O.setBPM(125),W=_=we.waveFormFunction.sine,L=[],G=[];for(var e=0;e<S;e++)G.push({}),L.push({});O.useLinearFrequency=!1,O.setTrackerMode(he),O.isPlugin||we.setMasterVolume(1),we.setAmigaLowPassFilter(!1,0)}function h(){for(var e=[],t=0;t<E;t++){var n,r=[];for(n=0;n<S;n++)r.push(Me());e.push(r)}return e}for(var r,b,a,n,t,y,_,W,T,O={},o=!(O.isMaster=!0),u=!1,l=[],d=1,p=0,c=0,f=me,w=0,P=0,F=125,R=6,N=2.5/F,S=4,E=64,x=he,C=0,G=[],L=[],A=[],q=[],H=[],B=0;B<S;B++)G.push({}),L.push({});O.init=function(t){for(var e=-8;e<8;e++)Fe[e]={};for(var n in fe)if(fe.hasOwnProperty(n)){var r=fe[n];if(Ee.push((Se[(Pe[r.period]=r).name]=r).name),r.tune)for(e=-8;e<8;e++){Fe[e][r.tune[e+8]]=r.period}}var a=0;for(n in ve)if(ve.hasOwnProperty(n)){var o=ve[n];o.period||(o.period=1),ke.push(o),xe[o.period]=a,o.modPeriod&&(xe[o.modPeriod]=a),a++}t&&(V.init(),we.init(t.audioContext,t.audioDestination),t.plugin&&(O.isPlugin=!0,U.initPlugin(t),"boolean"==typeof t.isMaster&&(O.isMaster=t.isMaster),t.handler&&(Te.on(te,function(e){t.handler(te,e)}),Te.on(pe,function(e){t.handler(pe,e)}),Te.on(ee,function(e){t.handler(ee,e)}),Te.on(de,function(e){t.handler(de,e)}),Te.on(le,function(e){t.handler(le,e)}))))},O.setMaster=function(e){O.isMaster=e},O.isMaster=function(){return!!O.isMaster},O.setCurrentInstrumentIndex=function(e){if(b.instruments[e])a!=(d=e)&&Te.trigger(z,d),a=d;else if(e<=O.getMaxInstruments()){for(var t=b.instruments.length,n=e;t<=n;t++)O.setInstrument(t,Be());var r=[];for(t=1;t<=n;t++){r.push({label:t+" "+(b.instruments[t]||{name:""}).name,data:t}),Te.trigger(se,r)}a!=(d=e)&&Te.trigger(z,d),a=d}},O.getCurrentInstrumentIndex=function(){return d},O.getCurrentInstrument=function(){return l[d]},O.getMaxInstruments=function(){return O.inFTMode()?128:31},O.setCurrentPattern=function(e){(y=b.patterns[p=e])||(y=h(),b.patterns[p]=y),E=y.length,n!=p&&Te.trigger(K,p),n=p},O.getCurrentPattern=function(){return p},O.getCurrentPatternData=function(){return y},O.updatePatternTable=function(e,t){Te.trigger(Q,b.patternTable[e]=t),e==w&&(n=void 0,Ce.setCurrentPattern(t))},O.setCurrentPatternPos=function(e){t!=(c=e)&&Te.trigger(X,{current:c,prev:t}),t=c},O.getCurrentPatternPos=function(){return c},O.moveCurrentPatternPos=function(e){var t=c+e,n=E-1;t<0&&(t=n),n<t&&(t=0),O.setCurrentPatternPos(t)},O.getCurrentSongPosition=function(){return w},O.setCurrentSongPosition=function(e,t){(w=e)!=P&&(Te.trigger($,w),b.patternTable&&O.setCurrentPattern(b.patternTable[w]),P=w,t&&O.isPlaying()&&(O.stop(),O.togglePlay()))},O.addToPatternTable=function(e,t){void 0===e&&(e=b.length),t=t||0,e==b.length&&(b.patternTable[e]=t,b.length++),Te.trigger(ne,b),Te.trigger(Q)},O.removeFromPatternTable=function(e){b.length<2||(void 0===e&&(e=b.length-1),e==b.length-1&&(b.patternTable[e]=0,b.length--),w==b.length&&O.setCurrentSongPosition(w-1),Te.trigger(ne,b),Te.trigger(Q))},O.setPlayType=function(e){Te.trigger(Y,f=e)},O.getPlayType=function(){return f},O.playSong=function(){O.stop(),we.checkState(),O.setPlayType(me),u=!0,e(p),Te.trigger(J,u)},O.playPattern=function(){O.stop(),we.checkState(),c=0,O.setPlayType(ce),u=!0,e(p),Te.trigger(J,u)},O.stop=function(){r&&r.stop(),we.disable(),O.isPlugin||we.setMasterVolume(1),U&&(U.setStatus("Ready"),Input.clearInputNotes()),O.clearEffectCache();for(var e=0;e<S;e++)if(G[e].source)try{G[e].source.stop()}catch(e){}Te.trigger(J,u=!1)},O.pause=function(){r&&r.stop(),Te.trigger(J,u=!1)},O.togglePlay=function(){O.isPlaying()?O.stop():f==ce?O.playPattern():O.playSong()},O.getProperties=function(){return{ticksPerStep:R,tickTime:N}},O.playPatternStep=v,O.cutNote=D,O.setBPM=function(e,t){var n=t&&t.isMaster;O.isMaster||n?(r&&r.timeStretch(we.context.currentTime,[T],F/e),n||Te.trigger(pe,F),N=2.5/(F=e),Te.trigger(te,F)):Te.trigger(pe,e)},O.getBPM=function(){return F},O.setAmigaSpeed=function(e,t){O.isMaster||t&&t.isMaster?Te.trigger(ee,R=e):Te.trigger(de,e)},O.getAmigaSpeed=function(){return R},O.getSwing=function(){return C},O.setSwing=function(e){C=e},O.getPatternLength=function(){return E},O.setPatternLength=function(e){var t=b.patterns[p].length;if(t!==(E=e)){if(t<E)for(var n=t;n<E;n++){var r,a=[];for(r=0;r<S;r++)a.push(Me());b.patterns[p].push(a)}else b.patterns[p]=b.patterns[p].splice(0,E),E<=c&&O.setCurrentPatternPos(E-1);Te.trigger(K,p)}},O.getTrackCount=function(){return S},O.setTrackCount=function(e){S=e;for(var t=G.length;t<S;t++)G.push({});for(t=L.length;t<S;t++)L.push({});Te.trigger(ae,S)},O.toggleRecord=function(){O.stop(),Te.trigger(Z,o=!o)},O.isPlaying=function(){return u},O.isRecording=function(){return o},O.setStateAtTime=function(e,t){A.push({time:e,state:t})},O.getStateAtTime=function(e){for(var t=void 0,n=0,r=A.length;n<r;n++){if(!(A[0].time<e))return t;t=A.shift().state}return t},O.getTimeStates=function(){return A},O.setPeriodAtTime=function(e,t,n){if(t=Math.max(t,1),O.inFTMode()&&O.useLinearFrequency)var r=8363*Math.pow(2,(4608-t)/768)/we.context.sampleRate;else r=e.startPeriod/t,r*=e.startPlaybackRate;e.source.playbackRate.setValueAtTime(r,n),e.source.playbackRate.setValueAtTime(r,n+.005)},O.load=function(i,s,u,t){(i=i||"demomods/StardustMemories.mod").indexOf("://")<0&&0!==i.indexOf("/")&&(i=V.getBaseUrl()+i),U&&(U.setInfo(""),U.setLoading());function n(e){t&&!V.useInitialLoad||O.processFile(e,l,function(e){if(U&&U.setStatus("Ready"),e){var t="",n="";if("string"==typeof i){if(0<i.indexOf("modarchive.org")){var r=i.split("moduleid=")[1];b.filename=r.split("#")[1]||r,n="modArchive",t="https://modarchive.org/index.php?request=view_by_moduleid&query="+(r=(r=r.split("#")[0]).split("&")[0]),Te.trigger(ne,b)}0<i.indexOf("modules.pl")&&(r=i.split("modules.pl/")[1],b.filename=r.split("#")[1]||r,n="modules.pl",t="http://www.modules.pl/?id=module&mod="+(r=(r=r.split("#")[0]).split("&")[0]),Te.trigger(ne,b))}U&&U.setInfo(b.title,n,t)}if(U&&e&&!s){var a=window.location.pathname,o=a.substring(a.lastIndexOf("/")+1);window.history.pushState&&window.history.pushState({},l,o+"?file="+encodeURIComponent(i))}e&&M(s),u&&u()})}var e,r,a,l="";"string"==typeof i?(l=i.substr(i.lastIndexOf("/")+1),e=i,r=function(e){n(e)},(a=new XMLHttpRequest).open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(e){var t=a.response;t&&200===a.status?r&&r(t):"undefined"!=typeof Editor&&r&&r(!1)},a.send(null)):(l=i.name||"",s=!0,n(i.buffer||i))};var M=function(e){var t=function(e){if(window.location.getParameter)return window.location.getParameter(e);if(location.search)for(var t=location.search.substring(1).split("&"),n=0;n<t.length;n++){var r=t[n].split("=");if(r[0]&&r[0]==e)return r[1]||!0}}("autoplay");Ce.autoPlay&&(t="1"),!U&&e&&(t="1"),"true"!=t&&"1"!=t||Ce.playSong()};return O.handleUpload=function(e){if(e.length){var t=e[0],n=new FileReader;n.onload=function(){O.processFile(n.result,t.name,function(e){U&&U.setStatus("Ready")})},n.readAsArrayBuffer(t)}},O.processFile=function(e,r,a){var t=!1,n=new I(e,!0),o=Ae.detect(n,r);o&&"ZIP"==o.name&&(U&&U.setStatus("Extracting Zip file",!0),zip.workerScriptsPath="script/src/lib/zip/",zip.useWebWorkers=V.useWebWorkers,zip.createReader(new zip.ArrayBufferReader(e),function(e){var t,n=0;e.getEntries(function(e){e&&e.length&&e.forEach(function(e){n<e.uncompressedSize&&(n=e.uncompressedSize,t=e)}),t?t.getData(new zip.ArrayBufferWriter,function(e){e&&e.byteLength&&O.processFile(e,r,a)}):a&&a(!1)})},function(e){a&&a(!1)})),o.isMod&&o.loader&&(t=!0,O.isPlaying()&&O.stop(),s(),(b=o.loader().load(n,r)).filename=r,i()),o.isSample&&"undefined"!=typeof Editor&&Editor.importSample(n,r),a&&a(t)},O.getSong=function(){return b},O.getInstruments=function(){return l},O.getInstrument=function(e){return l[e]},O.setInstrument=function(e,t){l[t.instrumentIndex=e]=t},O.clearEffectCache=function(){L=[];for(var e=0;e<S;e++)L.push({})},O.clearInstruments=function(e){if(b){var t=[],n=e||b.instruments.length-1;for(l=[],B=1;B<=n;B++)O.setInstrument(B,Be()),t.push({label:B+" ",data:B});b.instruments=l,Te.trigger(se,t),Te.trigger(z,d)}},O.setTrackerMode=function(e){x=e,ye.emulateProtracker1OffsetBug=!O.inFTMode(),Te.trigger(ie,e)},O.getTrackerMode=function(){return x},O.inFTMode=function(){return x===be},O.new=function(){s(),b={patterns:[],instruments:[]},O.clearInstruments(31),b.typeId="M.K.",b.title="new song",b.length=1,b.restartPosition=0,b.patterns.push(h());for(var e=[],t=0;t<128;++t)e[t]=0;b.patternTable=e,i()},O.clearInstrument=function(){l[d]=Be(),Te.trigger(z,d),Te.trigger(re,d)},O.getFileName=function(){return b.filename||(b.title?b.title.replace(/ /g,"-").replace(/\W/g,"")+".mod":"new.mod")},O.useLinearFrequency=!0,O}(),M=function(){var o={load:function(e,t,n){o.type=t||s,o.loadCount=0,o.max=e.length,o.next=n;for(var r=0,a=e.length;r<a;r++)i(e[r])}},i=function(t){if(o.type==s){var e=new Image;e.onload=function(){C.images[t]=this,++o.loadCount==o.max&&o.next&&o.next()},e.onerror=function(){alert("BufferLoader: XHR error")},e.src=t}if(o.type==A){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",t,!0),n.onload=function(){we.context.decodeAudioData(n.response,function(e){e?(C.audio[t]=e,++o.loadCount==o.max&&o.next&&o.next()):alert("error decoding file data: "+t)},function(e){})},n.onerror=function(){alert("BufferLoader: XHR error")},n.send()}};return o},Ae=((i={}).get=function(e,t){i.ajax({url:e,success:function(e){t(e)},error:function(e){t(void 0,e)}})},i.post=function(e,t,n){var r=t;if("object"==typeof t){for(var a in r="",t)t.hasOwnProperty(a)&&(r+="&"+a+"="+encodeURIComponent(t[a]));r.length&&(r=r.substr(1))}i.ajax({method:"POST",url:e,data:r,datatype:"form",success:function(e){n(e)},error:function(e){n(void 0,e)}})},i.sendBinary=function(e,t,n){i.ajax({method:"POST",url:e,data:t,success:function(e){n(e)},error:function(e){n(void 0,e)}})},i.json=function(e,t){void 0===t&&(t=function(){}),i.ajax({url:e,cache:!1,datatype:"json",headers:[{key:"Accept",value:"application/json"}],success:function(e){t(e)},error:function(e){t(void 0,e)}})},i.html=function(e,t){i.ajax({url:e,cache:!1,datatype:"html",success:function(e){t(e)},error:function(e){t(void 0,e)}})},i.ajax=function(t){var n=new XMLHttpRequest;t.error=t.error||function(){t.success(!1)},"jsonp"===t.datatype&&t.error(n);var e=t.url;if("boolean"==typeof t.cache&&!t.cache&&V.useUrlParams){var r=(new Date).getTime();e+=0<e.indexOf("?")?"&r="+r:"?r="+r}var a=t.method||"GET";n.onreadystatechange=function(){if(!(n.readyState<4)&&4===n.readyState)if(200!==n.status&&201!==n.status)t.error(n);else{var e=n.responseText;"json"===t.datatype&&(e=JSON.parse(e)),"html"===t.datatype&&((e=document.createElement("div")).innerHTML=n.responseText),t.success(e)}},n.ontimeout=function(e){},n.open(a,e,!0),n.timeout=t.timeout||3e4,t.headers&&t.headers.forEach(function(e){n.setRequestHeader(e.key,e.value)});var o=t.data||"";"POST"===a&&t.data&&"form"===t.datatype&&n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send(o)},l={unknown:{name:"UNKNOWN"},unsupported:{name:"UNSUPPORTED"},mod_ProTracker:{name:"PROTRACKER",isMod:!0,loader:function(){return a()}},mod_SoundTracker:{name:"SOUNDTRACKER",isMod:!0,loader:function(){return d()}},mod_FastTracker:{name:"FASTTRACKER",isMod:!0,loader:function(){return g()}},sample:{name:"SAMPLE",isSample:!0},zip:{name:"ZIP"}},(r={}).detect=function(a,e){function o(e){return e<128}var i=a.length,t="";if("Extended Module: "==(t=a.readString(17,0)))return l.mod_FastTracker;if(1100<i&&(t=a.readString(4,1080)),"M.K."==t)return l.mod_ProTracker;if("M!K!"==t)return l.mod_ProTracker;if("M&K!"==t)return l.mod_ProTracker;if("FLT4"==t)return l.mod_ProTracker;if("2CHN"==t)return l.mod_ProTracker;if("6CHN"==t)return l.mod_ProTracker;if("8CHN"==t)return l.mod_ProTracker;if("10CH"==t)return l.mod_ProTracker;if("12CH"==t)return l.mod_ProTracker;if("14CH"==t)return l.mod_ProTracker;if("16CH"==t)return l.mod_ProTracker;if("18CH"==t)return l.mod_ProTracker;if("20CH"==t)return l.mod_ProTracker;if("22CH"==t)return l.mod_ProTracker;if("24CH"==t)return l.mod_ProTracker;if("26CH"==t)return l.mod_ProTracker;if("28CH"==t)return l.mod_ProTracker;if("30CH"==t)return l.mod_ProTracker;if("32CH"==t)return l.mod_ProTracker;var n="";return e&&4<e.length&&(n=e.substr(e.length-4)),".wav"==(n=n.toLowerCase())||".mp3"==n||".iff"==n?l.sample:".zip"==n||"PK"==a.readString(2,0)?l.zip:e&&0<=e.indexOf(".")&&1624<i&&function(){a.goto(0);for(var e=0;e<20;e++)if(!o(a.readByte()))return;for(var t=0,n=0,r=0;r<15;r++){for(e=0;e<22;e++)if(!o(a.readByte()))return;if(a.jump(-22),"st-"==a.readString(22).toLowerCase().substr(0,3)&&(n+=10),20<n)return 1;t+=a.readWord(),a.jump(6)}return!(i<2*t+1624)}()?l.mod_SoundTracker:l.sample},r),a=function(){var e={load:function(e,t){Ce.setTrackerMode(he),Ce.useLinearFrequency=!1,Ce.clearInstruments(31);var n={patterns:[],restartPosition:1},r=4;n.typeId=e.readString(4,1080),n.title=e.readString(20,0),"2CHN"===n.typeId&&(r=2),"6CHN"===n.typeId&&(r=6),"8CHN"===n.typeId&&(r=8),"10CH"===n.typeId&&(r=10),"12CH"===n.typeId&&(r=12),"14CH"===n.typeId&&(r=14),"16CH"===n.typeId&&(r=16),"18CH"===n.typeId&&(r=18),"20CH"===n.typeId&&(r=20),"22CH"===n.typeId&&(r=22),"24CH"===n.typeId&&(r=24),"26CH"===n.typeId&&(r=26),"28CH"===n.typeId&&(r=28),"30CH"===n.typeId&&(r=30),"32CH"===n.typeId&&(r=32),n.channels=r;var a=0;for(p=1;p<=31;++p){var o=e.readString(22),i=e.readWord(),s=Be();s.name=o,s.sample.length=s.sample.realLen=i<<1;var u=e.readUbyte();7<u&&(u-=16),s.setFineTune(u),s.sample.volume=e.readUbyte(),s.sample.loop.start=e.readWord()<<1,s.sample.loop.length=e.readWord()<<1,s.sample.loop.enabled=2<s.sample.loop.length,s.sample.loop.type=x,s.pointer=a,a+=s.sample.length,s.setSampleIndex(0),Ce.setInstrument(p,s)}n.instruments=Ce.getInstruments(),e.goto(950),n.length=e.readUbyte(),e.jump(1);for(var l=[],d=0,p=0;p<128;++p)l[p]=e.readUbyte(),d<l[p]&&(d=l[p]);for(n.patternTable=l,e.goto(1084),p=0;p<=d;++p){for(var m=[],c=0;c<64;c++){var f,v=[];for(f=0;f<r;f++){var g=Me(),h=e.readUint();g.setPeriod(h>>16&4095),g.effect=h>>8&15,g.instrument=h>>24&240|h>>12&15,g.param=255&h,v.push(g)}for(f=r;f<Ce.getTrackCount();f++)v.push(Me());m.push(v)}n.patterns.push(m)}var b=[];for(p=1;p<=31;p++)if(s=Ce.getInstrument(p)){var y=s.sample.length;for(2<s.sample.loop.length&&ye.unrollShortLoops&&s.sample.loop.length<1e3&&(y=Math.min(y,s.sample.loop.start+s.sample.loop.length),s.sample.length=y),j=0;j<y;j++){var T=e.readByte();j<2&&(T=0),s.sample.data.push(T/127)}if((ye.unrollShortLoops||ye.unrollLoops)&&2<s.sample.loop.length){var w=Math.ceil(4e4/s.sample.loop.length)+1;ye.unrollLoops||(w=0);var P=!1,F=0;ye.unrollShortLoops&&s.sample.loop.length<1600&&(w=Math.floor(1e3/s.sample.loop.length),P=!0);for(var S=0;S<w;S++){var E=s.sample.loop.start,k=E+s.sample.loop.length;for(j=E;j<k;j++)s.sample.data.push(s.sample.data[j]);F+=s.sample.loop.length}P&&F&&(s.sample.loop.length+=F,s.sample.length+=F)}b.push({label:p+" "+s.name,data:p})}return Te.trigger(se,b),n},write:function(e){var t,n=Ce.getSong(),r=Ce.getInstruments(),a=Ce.getTrackCount(),o=Ce.getPatternLength(),i=1084,s=0;for(t=0;t<128;t++){var u=n.patternTable[t]||0;s=Math.max(s,u)}i+=(s+1)*(256*a),r.forEach(function(e){e&&(e.setSampleIndex(0),i+=e.sample.length)});var l=new I(new ArrayBuffer(i),!0);for(l.writeStringSection(n.title,20),r.forEach(function(e){e?(e.sample.length=Math.min(e.sample.length,131070),l.writeStringSection(e.name,22),l.writeWord(e.sample.length>>1),l.writeUByte(e.sample.finetune),l.writeUByte(e.sample.volume),l.writeWord(e.sample.loop.start>>1),l.writeWord(e.sample.loop.length>>1)):l.clear(30)}),l.writeUByte(n.length),l.writeUByte(127),t=0;t<128;t++){l.writeUByte(u=n.patternTable[t]||0)}for(l.writeString(8==a?"8CHN":"M.K."),t=0;t<=s;t++)for(var d=n.patterns[t],p=0;p<o;p++)for(var m=d[p],c=0;c<a;c++){var f=m[c],v=0,g=f.instrument;15<g&&(g=f.instrument-(v=16)),l.writeUint((v<<24)+(f.period<<16)+(g<<12)+(f.effect<<8)+f.param)}r.forEach(function(e){if(e&&e.sample.data&&e.sample.length)for(l.clear(2),t=0;t<e.sample.length-2;t++)l.writeByte(Math.round(127*(e.sample.data[t]||0)))}),e&&e(l)}};return e},d=function(){var e={load:function(e,t){Ce.setTrackerMode(he),Ce.useLinearFrequency=!1,Ce.clearInstruments(15);var n={patterns:[],restartPosition:1};n.typeId="ST",n.channels=4,n.title=e.readString(20,0);var r=0;for(l=1;l<=15;++l){var a=e.readString(22),o=e.readWord(),i=Be();i.name=a,i.sample.length=i.realLen=o<<1,i.sample.volume=e.readWord(),i.setFineTune(0),i.sample.loop.start=e.readWord(),i.sample.loop.length=e.readWord()<<1,i.sample.loop.enabled=2<i.sample.loop.length,i.sample.loop.type=x,i.pointer=r,r+=i.sample.length,i.setSampleIndex(0),Ce.setInstrument(l,i)}n.instruments=Ce.getInstruments(),e.goto(470),n.length=e.readUbyte(),n.speed=e.readUbyte();for(var s=[],u=0,l=0;l<128;++l)s[l]=e.readUbyte(),u<s[l]&&(u=s[l]);for(n.patternTable=s,e.goto(600),l=0;l<=u;++l){for(var d=[],p=0;p<64;p++){var m,c=[];for(m=0;m<4;m++){var f={},v=e.readUint();f.period=v>>16&4095,f.effect=v>>8&15,f.instrument=v>>24&240|v>>12&15,f.param=255&v,c.push(f)}for(m=4;m<Ce.getTrackCount();m++)c.push({note:0,effect:0,instrument:0,param:0});d.push(c)}n.patterns.push(d)}var g=[];for(l=1;l<=15;l++)if(i=Ce.getInstrument(l)){var h=i.sample.length;for(j=0;j<h;j++){var b=e.readByte();j<2&&(b=0),i.sample.data.push(b/127)}g.push({label:l+" "+i.name,data:l})}return Te.trigger(se,g),n}};return e},g=function(){var k={load:function(e,t){function n(e){for(e.points=[],b=0;b<12;b++)e.points.push(e.raw.slice(2*b,2*b+2));return 1&e.type&&(e.enabled=!0),2&e.type&&(e.sustain=!0),4&e.type&&(e.loop=!0),e}Ce.setTrackerMode(be),Ce.clearInstruments(1);var r={},a={patterns:[],instruments:[]};e.litteEndian=!0,e.goto(17),a.title=e.readString(20),e.jump(1),r.trackerName=e.readString(20),r.trackerVersion=e.readByte(),r.trackerVersion=e.readByte()+"."+r.trackerVersion,r.headerSize=e.readDWord(),r.songlength=e.readWord(),r.restartPosition=e.readWord(),r.numberOfChannels=e.readWord(),r.numberOfPatterns=e.readWord(),r.numberOfInstruments=e.readWord(),r.flags=e.readWord(),Ce.useLinearFrequency=r.flags%2==1,r.defaultTempo=e.readWord(),r.defaultBPM=e.readWord();for(var o=[],i=0,s=0;s<r.songlength;++s)o[s]=e.readUbyte(),i<o[s]&&(i=o[s]);a.patternTable=o,a.length=r.songlength,a.channels=r.numberOfChannels,a.restartPosition=r.restartPosition+1;var u=60+r.headerSize;for(e.goto(u),s=0;s<r.numberOfPatterns;s++){var l=[],d={};d.headerSize=e.readDWord(),d.packingType=e.readUbyte(),d.patternLength=e.readWord(),d.patternSize=e.readWord(),e.goto(u+=d.headerSize);for(var p=0;p<d.patternLength;p++){var m,c=[];for(m=0;m<r.numberOfChannels;m++){var f=Me(),v=e.readUbyte();128&v?(1&v&&f.setIndex(e.readUbyte()),2&v&&(f.instrument=e.readUbyte()),4&v&&(f.volumeEffect=e.readUbyte()),8&v&&(f.effect=e.readUbyte()),16&v&&(f.param=e.readUbyte())):(f.setIndex(v),f.instrument=e.readUbyte(),f.volumeEffect=e.readUbyte(),f.effect=e.readUbyte(),f.param=e.readUbyte()),c.push(f)}l.push(c)}e.goto(u+=d.patternSize),a.patterns.push(l)}var g=[];for(s=1;s<=r.numberOfInstruments;++s){var h=Be();try{if(h.filePosition=e.index,h.headerSize=e.readDWord(),h.name=e.readString(22),h.type=e.readUbyte(),h.numberOfSamples=e.readWord(),h.samples=[],(h.sampleHeaderSize=0)<h.numberOfSamples){h.sampleHeaderSize=e.readDWord(),h.sampleHeaderSize=Math.max(h.sampleHeaderSize,40),200<h.sampleHeaderSize&&(h.sampleHeaderSize=40);for(var b=0;b<96;b++)h.sampleNumberForNotes.push(e.readUbyte());for(b=0;b<24;b++)h.volumeEnvelope.raw.push(e.readWord());for(b=0;b<24;b++)h.panningEnvelope.raw.push(e.readWord());h.volumeEnvelope.count=e.readUbyte(),h.panningEnvelope.count=e.readUbyte(),h.volumeEnvelope.sustainPoint=e.readUbyte(),h.volumeEnvelope.loopStartPoint=e.readUbyte(),h.volumeEnvelope.loopEndPoint=e.readUbyte(),h.panningEnvelope.sustainPoint=e.readUbyte(),h.panningEnvelope.loopStartPoint=e.readUbyte(),h.panningEnvelope.loopEndPoint=e.readUbyte(),h.volumeEnvelope.type=e.readUbyte(),h.panningEnvelope.type=e.readUbyte(),h.vibrato.type=e.readUbyte(),h.vibrato.sweep=e.readUbyte(),h.vibrato.depth=Math.min(e.readUbyte(),15),h.vibrato.rate=e.readUbyte(),h.fadeout=e.readWord(),h.reserved=e.readWord(),h.volumeEnvelope=n(h.volumeEnvelope),h.panningEnvelope=n(h.panningEnvelope)}}catch(e){}if(e.goto(u+=h.headerSize),0===h.numberOfSamples){var y=D();h.samples.push(y)}else{if(e.isEOF(1))break;for(var T=0;T<h.numberOfSamples;T++)(y=D()).length=e.readDWord(),y.loop.start=e.readDWord(),y.loop.length=e.readDWord(),y.volume=e.readUbyte(),y.finetuneX=e.readByte(),y.type=e.readUbyte(),y.panning=e.readUbyte()-128,y.relativeNote=e.readByte(),y.reserved=e.readByte(),y.name=e.readString(22),y.bits=8,h.samples.push(y),e.goto(u+=h.sampleHeaderSize);for(T=0;T<h.numberOfSamples;T++)if((y=h.samples[T]).length){u+=y.length,16&y.type&&(y.bits=16,y.type^=16,y.length>>=1,y.loop.start>>=1,y.loop.length>>=1),y.loop.type=y.type||0,y.loop.enabled=!!y.loop.type;var w=y.length,P=0;if(16===y.bits)for(var F=0;F<w;F++){var S=e.readShort()+P;S<-32768?S+=65536:32767<S&&(S-=65536),y.data.push((P=S)/32768)}else for(F=0;F<w;F++)(S=e.readByte()+P)<-128?S+=256:127<S&&(S-=256),y.data.push((P=S)/127);if(y.loop.type===B){var E=y.data.slice(y.loop.start,y.loop.start+y.loop.length);y.data=y.data.slice(0,y.loop.start+y.loop.length),y.data=y.data.concat(E.reverse()),y.loop.length=2*y.loop.length,y.length=y.loop.start+y.loop.length}e.goto(u)}}h.setSampleIndex(0),Ce.setInstrument(s,h),g.push({label:s+" "+h.name,data:s})}return Te.trigger(se,g),a.instruments=Ce.getInstruments(),Ce.setBPM(r.defaultBPM),Ce.setAmigaSpeed(r.defaultTempo),k.validate(a),a},write:function(e){var t=Ce.getSong(),n=Ce.getInstruments(),r=Ce.getTrackCount(),a="undefined"==typeof versionNumber?"dev":versionNumber,o=0;for(i=0;i<128;i++){o=Math.max(o,t.patternTable[i]||0)}var i,s=336;for(i=0;i<=o;i++)t.patterns[i]&&(s+=9+t.patterns[i].length*r*5);for(i=1;i<n.length;i++){var u=n[i];u&&u.hasSamples()?u.samples.forEach(function(e){var t=e.length;16===e.bits&&(t*=2),s+=283+t}):s+=29}var l=new I(new ArrayBuffer(s),!1);for(l.writeStringSection("Extended Module: ",17),l.writeStringSection(t.title,20),l.writeByte(26),l.writeStringSection("BassoonTracker "+a,20),l.writeByte(4),l.writeByte(1),l.writeDWord(276),l.writeWord(t.length),l.writeWord(0),l.writeWord(Ce.getTrackCount()),l.writeWord(o+1),l.writeWord(n.length-1),l.writeWord(Ce.useLinearFrequency?1:0),l.writeWord(Ce.getAmigaSpeed()),l.writeWord(Ce.getBPM()),i=0;i<256;i++)l.writeUByte(t.patternTable[i]||0);for(i=0;i<=o;i++){var d=t.patterns[i],p=0,m=0;if(d&&(m=(p=d.length)*r*5),l.writeDWord(9),l.writeUByte(0),l.writeWord(p),l.writeWord(m),d)for(var c=0,f=d.length;c<f;c++)for(var v=d[c],g=0;g<r;g++){var h=v[g]||{};l.writeUByte(h.index||0),l.writeUByte(h.instrument||0),l.writeUByte(h.volumeEffect||0),l.writeUByte(h.effect||0),l.writeUByte(h.param||0)}}for(i=1;i<n.length;i++)if((u=n[i])&&u.hasSamples()){u.numberOfSamples=u.samples.length,l.writeDWord(243),l.writeStringSection(u.name,22),l.writeUByte(0),l.writeWord(u.numberOfSamples);var b=(u.volumeEnvelope.enabled?1:0)+(u.volumeEnvelope.sustain?2:0)+(u.volumeEnvelope.loop?4:0),y=(u.panningEnvelope.enabled?1:0)+(u.panningEnvelope.sustain?2:0)+(u.panningEnvelope.loop?4:0);l.writeDWord(40);for(var T=0;T<96;T++)l.writeUByte(u.sampleNumberForNotes[T]||0);for(T=0;T<12;T++){var w=u.volumeEnvelope.points[T]||[0,0];l.writeWord(w[0]),l.writeWord(w[1])}for(T=0;T<12;T++)l.writeWord((w=u.panningEnvelope.points[T]||[0,0])[0]),l.writeWord(w[1]);l.writeUByte(u.volumeEnvelope.count||0),l.writeUByte(u.panningEnvelope.count||0),l.writeUByte(u.volumeEnvelope.sustainPoint||0),l.writeUByte(u.volumeEnvelope.loopStartPoint||0),l.writeUByte(u.volumeEnvelope.loopEndPoint||0),l.writeUByte(u.panningEnvelope.sustainPoint||0),l.writeUByte(u.panningEnvelope.loopStartPoint||0),l.writeUByte(u.panningEnvelope.loopEndPoint||0),l.writeUByte(b),l.writeUByte(y),l.writeUByte(u.vibrato.type||0),l.writeUByte(u.vibrato.sweep||0),l.writeUByte(u.vibrato.depth||0),l.writeUByte(u.vibrato.rate||0),l.writeWord(u.fadeout||0),l.writeWord(0);for(var P=0;P<u.numberOfSamples;P++){var F=u.samples[P],S=0;2<F.loop.length&&F.loop.enabled&&(S=1);var E=F.length,k=F.loop.start,x=F.loop.length;16===F.bits&&(S+=16,E*=2,k*=2,x*=2),l.writeDWord(E),l.writeDWord(k),l.writeDWord(x),l.writeUByte(F.volume),l.writeByte(F.finetuneX),l.writeUByte(S),l.writeUByte((F.panning||0)+128),l.writeUByte(F.relativeNote||0),l.writeUByte(0),l.writeStringSection(F.name||"",22)}for(P=0;P<u.numberOfSamples;P++){var C,A=0,B=0;if(16===(F=u.samples[P]).bits)for(T=0,f=F.length;T<f;T++)A=(C=Math.round(32768*F.data[T]))-B,B=C,A<-32768?A+=65536:32767<A&&(A-=65536),l.writeWord(A);else for(T=0,f=F.length;T<f;T++)A=(C=Math.round(127*F.data[T]))-B,B=C,A<-128?A+=256:127<A&&(A-=256),l.writeByte(A)}}else l.writeDWord(29),l.writeStringSection(u?u.name:"",22),l.writeUByte(0),l.writeWord(0);e&&e(l)},validate:function(e){function a(e,t){var n=!0;if(e.points&&e.points[0])if(0===e.points[0][0])for(var r=0,a=1;a<e.count;a++){var o=e.points[a];o&&r<o[0]?r=o[0]:n=!1}else n=!1;else n=!1;return n?e:"volume"===t?{raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6}:{raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5}}e.instruments.forEach(function(e){e.volumeEnvelope=a(e.volumeEnvelope,"volume"),e.panningEnvelope=a(e.panningEnvelope,"panning");for(var t=e.samples.length-1,n=0,r=e.sampleNumberForNotes.length;n<r;n++)e.sampleNumberForNotes[n]=Math.min(e.sampleNumberForNotes[n],t)})}};return k},Be=function(){function i(e,t,n){var r=Ce.getProperties().tickTime,a=e.sustain?e.sustainPoint+1:e.count;e.loopStartPoint=Math.min(e.loopStartPoint,e.count-1),e.loopEndPoint=Math.min(e.loopEndPoint,e.count-1);var o=e.loop&&e.loopStartPoint<e.loopEndPoint;e.sustain&&e.sustainPoint<=e.loopStartPoint&&(o=!1),o&&(a=e.loopEndPoint+1);var i=0;if(t.gain)var s=t.gain,u=0,l=64;else s=t.pan,l=u=32;s.setValueAtTime((e.points[0][1]-u)/l,n);for(var d=1;d<a;d++){var p=e.points[d];s.linearRampToValueAtTime((p[1]-u)/l,n+(i=p[0]*r))}return!!o&&c.scheduleEnvelopeLoop(t,n,2,i)}var c={type:"sample",name:"",instrumentIndex:0,sampleIndex:-1,fadeout:128,data:[]};return c.samples=[D()],c.sample=c.samples[0],c.volumeEnvelope={raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6},c.panningEnvelope={raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5},c.vibrato={},c.sampleNumberForNotes=[],c.play=function(e,t,n,r,a,o){return Ce.inFTMode()&&(t=c.getPeriodForNote(e)),we.playSample(c.instrumentIndex,t,n,r,a,o,e)},c.noteOn=function(e){var t,n,r={};if(c.volumeEnvelope.enabled){t=we.context.createGain();var a=c.volumeEnvelope,o=i(a,t,e);o&&(r.volume=e+o)}return c.panningEnvelope.enabled&&we.usePanning&&(n=we.context.createStereoPanner(),(o=i(a=c.panningEnvelope,n,e))&&(r.panning=e+o)),c.vibrato.rate&&c.vibrato.depth&&(r.ticks=0,r.vibrato=e,r.vibratoFunction=c.getAutoVibratoFunction()),{volume:t,panning:n,scheduled:r}},c.noteOff=function(e,t){function n(){t.volume.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeEnvelope&&t.volumeEnvelope.gain.cancelScheduledValues(e),t.panningEnvelope&&t.panningEnvelope.pan.cancelScheduledValues(e),t.scheduled=void 0}if(t&&t.volume){if(Ce.inFTMode()){var r=Ce.getProperties().tickTime;if(c.volumeEnvelope.enabled){if(c.volumeEnvelope.sustain&&t.volumeEnvelope){n();var a=0,o=c.volumeEnvelope.points[c.volumeEnvelope.sustainPoint];o&&(a=o[0]*r);for(var i=c.volumeEnvelope.sustainPoint;i<c.volumeEnvelope.count;i++){var s=c.volumeEnvelope.points[i];s&&t.volumeEnvelope.gain.linearRampToValueAtTime(s[1]/64,e+s[0]*r-a)}}if(c.fadeout)t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+65536/c.fadeout*r/2)}else n(),t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+.1);if(c.panningEnvelope.enabled&&we.usePanning&&t.panningEnvelope)for(a=0,(o=c.panningEnvelope.points[c.panningEnvelope.sustainPoint])&&(a=o[0]*r),i=c.panningEnvelope.sustainPoint;i<c.panningEnvelope.count;i++)(s=c.panningEnvelope.points[i])&&t.panningEnvelope.pan.linearRampToValueAtTime((s[1]-32)/32,e+s[0]*r-a);return 100}if(n(),!t.isKey||!t.volume)return 0;t.volume.gain.linearRampToValueAtTime(0,e+.5)}},c.scheduleEnvelopeLoop=function(e,t,n,r){r=r||0;var a=Ce.getProperties().tickTime;if(e.gain)var o=c.volumeEnvelope,i=e.gain,s=0,u=64;else o=c.panningEnvelope,i=e.pan,u=s=32;var l=o.points[o.loopStartPoint],d=l[0];if(o.loop&&o.loopStartPoint<o.loopEndPoint)for(;r<n;)for(var p=r,m=o.loopStartPoint;m<=o.loopEndPoint;m++)i.linearRampToValueAtTime(((l=o.points[m])[1]-s)/u,t+(r=p+(l[0]-d)*a));return r},c.scheduleAutoVibrato=function(e,t){var n=0;e.scheduled.ticks=e.scheduled.ticks||0;var r,a,o,i,s=Ce.getProperties().tickTime,u=-c.vibrato.rate/40,l=c.vibrato.depth/8;for(Ce.useLinearFrequency&&(l*=4),e.source&&(r=e.startPeriod,a=e.scheduled.vibratoFunction||we.waveFormFunction.sine,o=e.scheduled.vibrato||we.context.currentTime,i=0);n<t;){if(n+=s,r){var d=1;c.vibrato.sweep&&e.scheduled.ticks<c.vibrato.sweep&&(d=1-(c.vibrato.sweep-e.scheduled.ticks)/c.vibrato.sweep);var p=a(r,e.scheduled.ticks,u,l*d);Ce.setPeriodAtTime(e,p,o+i*s),i++}e.scheduled.ticks++}return n},c.getAutoVibratoFunction=function(){switch(c.vibrato.type){case 1:return we.waveFormFunction.square;case 2:return we.waveFormFunction.saw;case 3:return we.waveFormFunction.sawInverse}return we.waveFormFunction.sine},c.resetVolume=function(e,t){if(t.volumeFadeOut&&(t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.setValueAtTime(1,e)),t.volumeEnvelope){t.volumeEnvelope.gain.cancelScheduledValues(e);var n=Ce.getProperties().tickTime,r=c.volumeEnvelope.sustain?c.volumeEnvelope.sustainPoint+1:c.volumeEnvelope.count;t.volumeEnvelope.gain.setValueAtTime(c.volumeEnvelope.points[0][1]/64,e);for(var a=1;a<r;a++){var o=c.volumeEnvelope.points[a];t.volumeEnvelope.gain.linearRampToValueAtTime(o[1]/64,e+o[0]*n)}}},c.getFineTune=function(){return Ce.inFTMode()?c.sample.finetuneX:c.sample.finetune},c.setFineTune=function(e){Ce.inFTMode()?(c.sample.finetuneX=e,c.sample.finetune=e>>4):(7<e&&(e-=15),c.sample.finetune=e,c.sample.finetuneX=e<<4)},c.getPeriodForNote=function(e,t){var n=0;return Ce.useLinearFrequency?(n=7680-64*(e-1),t&&(n-=c.getFineTune()/2)):(n=ke[e].period,t&&c.getFineTune()&&(n=we.getFineTuneForNote(e,c.getFineTune()))),n},c.setSampleForNoteIndex=function(e){var t=c.sampleNumberForNotes[e-1];t!==c.sampleIndex&&"number"==typeof t&&c.setSampleIndex(t)},c.setSampleIndex=function(e){c.sampleIndex!==e&&(c.sample=c.samples[e],c.sampleIndex=e,Te.trigger(n,c.instrumentIndex))},c.hasSamples=function(){for(var e=0,t=c.samples.length;e<t;e++)if(c.samples[e].length)return!0},c.hasVibrato=function(){return c.vibrato.rate&&c.vibrato.depth},c},D=function(){var a={data:[],length:0,name:"",bits:8,volume:64,finetune:0,finetuneX:0,panning:0,relativeNote:0,loop:{enabled:!1,start:0,length:0,type:0},check:function(){for(var e=0,t=0,n=0,r=a.data.length;n<r;n++)e=Math.min(e,a.data[n]),t=Math.max(t,a.data[n]);return{min:e,max:t}}};return a},Me=function(){var n={period:0,index:0,effect:0,instrument:0,param:0,volumeEffect:0,setPeriod:function(e){n.period=e,n.index=xe[e]||0},setIndex:function(e){var t=ke[n.index=e];t?(n.period=t.modPeriod||t.period,1===n.period&&(n.period=0)):n.period=0},clear:function(){n.instrument=0,n.period=0,n.effect=0,n.param=0,n.index=0,n.volumeEffect=0},duplicate:function(){return{instrument:n.instrument,period:n.period,effect:n.effect,param:n.param,volumeEffect:n.volumeEffect,note:n.index}},populate:function(e){n.instrument=e.instrument||0,n.period=e.period||0,n.effect=e.effect||0,n.param=e.param||0,n.volumeEffect=e.volumeEffect||0,n.index=e.note||e.index||0}};return n};return{init:Ce.init,load:Ce.load,playSong:Ce.playSong,stop:Ce.stop,togglePlay:Ce.togglePlay,isPlaying:Ce.isPlaying,getTrackCount:Ce.getTrackCount,getSong:Ce.getSong,getStateAtTime:Ce.getStateAtTime,setCurrentSongPosition:Ce.setCurrentSongPosition,setBPM:Ce.setBPM,getBPM:Ce.getBPM,setAmigaSpeed:Ce.setAmigaSpeed,getAmigaSpeed:Ce.getAmigaSpeed,setMaster:Ce.setMaster,isMaster:Ce.isMaster,audio:we}};"undefined"!=typeof HostBridge&&HostBridge.customConfig||(BassoonTracker=BassoonTracker());